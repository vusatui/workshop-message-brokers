# https://taskfile.dev

version: '3'

vars:
  PROFILE: workshop-mb
  REQ_MINIKUBE_VERSION: "1.35.0"
  K8S_VERSION: "v1.34.0"
  WELCOME: >
    Welcome! Thank you for showing your interest to this workshop.
    In order to run the playground, you need to have minikube and helm installed.
  FAREWELL: >
    Thank you for your time with us! We hope you found some useful tricks and tips for your tasks

tasks:
  default:
    desc: Start cluster, expose Headlamp and configure DNS
    cmds:
      - task: cluster.start
      - task: deploy.headlamp-ingress
      - task: configure.ingress-dns
      - task: dns.show-hosts
      - |
        echo ""
        echo "‚úÖ All ready!"
        echo "üåê Open: http://headlamp.test/"
        echo "If the browser doesn‚Äôt resolve, run:"
        echo "   task configure.ingress-dns"
        echo ""

  cluster.recreate:
    desc: Delete and create a fresh minikube profile to match current minikube images
    cmds:
      - minikube delete -p {{.PROFILE}} || true
      - >
        minikube start
        --profile={{.PROFILE}}
        --cpus={{.CPU_COUNT | default "2"}}
        --memory='{{.MEMORY_SIZE | default "4g"}}'
        --kubernetes-version={{.K8S_VERSION}}

  cluster.start:
    desc: Spin up a local cluster
    vars:
      CUR_MINIKUBE_VERSION: "$(minikube version --short | tr -d 'v.')"
      MIN_MINIKUBE_VERSION: "$(echo {{.REQ_MINIKUBE_VERSION}} | tr -d 'v.')"
    preconditions:
      - test -x "$(command -v docker)"
      - test -x "$(command -v helm)"
      - test -x "$(command -v minikube)"
      - sh: '[ "{{.CUR_MINIKUBE_VERSION}}" -ge "{{.MIN_MINIKUBE_VERSION}}" ]'
        msg: |
          Minikube version is too old.
          Please upgrade to version {{.REQ_MINIKUBE_VERSION}} or higher.

    cmds:
      - echo '{{.WELCOME}}'
      - >
        minikube start
        --profile={{.PROFILE}}
        --cpus={{.CPU_COUNT | default "2"}}
        --memory='{{.MEMORY_SIZE | default "4g"}}'
        --kubernetes-version={{.K8S_VERSION}}
      - |
        # Enable addons one-by-one (required by minikube).
        # –í–∞–∂–Ω–æ: –≤–∫–ª—é—á–∞–µ–º ingress —Ä–∞–Ω—å—à–µ headlamp, —á—Ç–æ–±—ã webhook —É–∂–µ –±—ã–ª –≥–æ—Ç–æ–≤.
        for a in ingress ingress-dns metrics-server registry default-storageclass headlamp kubetail; do
          echo ">> Enabling addon: $a"
          minikube addons enable "$a" -p {{.PROFILE}} || true
        done
      - |
        echo ">> Current addons:"
        minikube addons list -p {{.PROFILE}} || true
      - |
        echo ">> Waiting for headlamp resources..."
        minikube kubectl -p {{.PROFILE}} -- wait --for=condition=Available deployment/headlamp -n headlamp --timeout=300s || true
      - |
        echo ">> Creating headlamp token for 24h..."
        minikube kubectl -p {{.PROFILE}} -- create token headlamp -n headlamp --duration=24h || true

  configure.ingress-dns:
    desc: "Configure local DNS for *.test with smart fallback; prefer localhost when tunnel is running."
    cmds:
      - |
        set -euo pipefail

        PROFILE="{{.PROFILE}}"
        OS="$(uname -s)"

        # –°–æ–±–µ—Ä—ë–º —Ö–æ—Å—Ç—ã –∏–∑ –≤—Å–µ—Ö Ingress'–æ–≤ (–µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Ö–æ—Ç—è –±—ã headlamp.test)
        HOSTS="$(minikube kubectl -p "$PROFILE" -- \
          get ing --all-namespaces -o jsonpath='{range .items[*].spec.rules[*]}{.host}{"\n"}{end}' \
          | grep -E '^[^.[:space:]]+\..+' | sort -u || true)"
        [ -z "$HOSTS" ] && HOSTS="headlamp.test"

        # –û–ø—Ä–µ–¥–µ–ª–∏–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Ç—É–Ω–Ω–µ–ª—å (–∏—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è)
        if pgrep -fl "minikube tunnel.*-p[ =]$PROFILE" >/dev/null 2>&1; then
          TARGET_IP="127.0.0.1"
          echo ">> Detected running minikube tunnel for profile '$PROFILE' -> using $TARGET_IP"
        else
          TARGET_IP="$(minikube ip -p "$PROFILE")"
          echo ">> No tunnel detected, using minikube IP: $TARGET_IP"
        fi

        if [ "$OS" = "Darwin" ]; then
          sudo sed -i '' "/^# >>> minikube-${PROFILE}$/,/^# <<< minikube-${PROFILE}$/d" /etc/hosts || true
          {
            echo "# >>> minikube-${PROFILE}"
            echo "$TARGET_IP  $HOSTS"
            echo "# <<< minikube-${PROFILE}"
          } | sudo tee -a /etc/hosts >/dev/null
          sudo dscacheutil -flushcache || true
          sudo killall -HUP mDNSResponder || true
          echo "‚úÖ /etc/hosts updated: $HOSTS -> $TARGET_IP"
        elif [ "$OS" = "Linux" ]; then
          sudo sed -i "/^# >>> minikube-${PROFILE}$/,/^# <<< minikube-${PROFILE}$/d" /etc/hosts || true
          {
            echo "# >>> minikube-${PROFILE}"
            echo "$TARGET_IP  $HOSTS"
            echo "# <<< minikube-${PROFILE}"
          } | sudo tee -a /etc/hosts >/dev/null
          echo "‚úÖ /etc/hosts updated: $HOSTS -> $TARGET_IP"
        else
          echo "Unsupported OS: $OS"
          exit 1
        fi

        echo ""
        echo "Try:  http://headlamp.test/"

  dns.cleanup-hosts:
    desc: "Remove /etc/hosts block added by configure.ingress-dns"
    cmds:
      - |
        PROFILE="{{.PROFILE}}"
        OS="$(uname -s)"
        if [ "$OS" = "Darwin" ]; then
          sudo sed -i '' "/^# >>> minikube-${PROFILE}$/,/^# <<< minikube-${PROFILE}$/d" /etc/hosts
        else
          sudo sed -i "/^# >>> minikube-${PROFILE}$/,/^# <<< minikube-${PROFILE}$/d" /etc/hosts
        fi
        echo "Removed /etc/hosts block for profile ${PROFILE} (if present)."

  dns.show-hosts:
    desc: "Show current Ingress hosts (from the cluster)"
    cmds:
      - |
        minikube kubectl -p {{.PROFILE}} -- \
          get ing --all-namespaces -o jsonpath='{range .items[*].spec.rules[*]}{.host}{"\n"}{end}' \
          | sort -u

  cluster.stop:
    desc: Stop and delete the local cluster
    preconditions:
      - test -x "$(command -v docker)"
      - test -x "$(command -v helm)"
      - test -x "$(command -v minikube)"
    cmds:
      - minikube stop --profile={{.PROFILE}} || true
      - minikube delete --profile={{.PROFILE}} || true
      - echo '{{.FAREWELL}}'

  # Matches "default" pipeline
  deploy.headlamp-ingress:
    desc: "Deploy Ingress for Headlamp dashboard (waits for nginx admission webhook)"
    cmds:
      - |
        set -euo pipefail
        echo ">> Waiting for ingress-nginx-controller to be Available..."
        minikube kubectl -p {{.PROFILE}} -- rollout status deploy/ingress-nginx-controller -n ingress-nginx --timeout=180s

        echo ">> Waiting for admission webhook endpoints..."
        for i in $(seq 1 60); do
          EP="$(minikube kubectl -p {{.PROFILE}} -- get endpoints -n ingress-nginx ingress-nginx-controller-admission -o jsonpath='{.subsets[0].addresses[0].ip}' 2>/dev/null || true)"
          if [ -n "$EP" ]; then
            echo "   admission endpoint: $EP"
            break
          fi
          echo "   retry $i/60: no endpoints yet..."
          sleep 2
        done

        # —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –ø—É—Å—Ç–æ ‚Äî –º—è–≥–∫–∏–π —Ä–µ—Å—Ç–∞—Ä—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∏ –µ—â—ë –æ–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π wait
        if [ -z "${EP:-}" ]; then
          echo ">> Admission endpoints still empty, restarting controller..."
          minikube kubectl -p {{.PROFILE}} -- rollout restart deploy/ingress-nginx-controller -n ingress-nginx
          minikube kubectl -p {{.PROFILE}} -- rollout status deploy/ingress-nginx-controller -n ingress-nginx --timeout=180s
          EP="$(minikube kubectl -p {{.PROFILE}} -- get endpoints -n ingress-nginx ingress-nginx-controller-admission -o jsonpath='{.subsets[0].addresses[0].ip}' 2>/dev/null || true)"
          if [ -z "$EP" ]; then
            echo "!! admission webhook still not ready ‚Äî aborting to avoid webhook errors"
            exit 1
          fi
          echo "   admission endpoint (after restart): $EP"
        fi

        echo ">> Waiting for headlamp service endpoints..."
        for i in $(seq 1 60); do
          HEP="$(minikube kubectl -p {{.PROFILE}} -- get endpoints -n headlamp headlamp -o jsonpath='{.subsets[0].addresses[0].ip}' 2>/dev/null || true)"
          if [ -n "$HEP" ]; then
            echo "   headlamp endpoint: $HEP"
            break
          fi
          echo "   retry $i/60: headlamp service not ready..."
          sleep 2
        done

        if [ -z "${HEP:-}" ]; then
          echo "!! headlamp service endpoints not ready ‚Äî aborting ingress apply"
          exit 1
        fi

        echo ">> Applying headlamp ingress‚Ä¶"
        minikube kubectl -p {{.PROFILE}} -- apply -f k8s/headlamp-ingress.yml

        echo ">> Current ingress:"
        minikube kubectl -p {{.PROFILE}} -- get ing -n headlamp headlamp-ingress -o wide

        echo ""
        echo "üåê Try:  http://headlamp.test/   (DNS already handled by configure.ingress-dns)"

  get.headlamp-token:
    desc: Issue an access token for headlamp admin panel
    cmds:
      - minikube kubectl -p {{.PROFILE}} -- create token headlamp --duration 24h -n headlamp

  tunnel.start:
    desc: "Run 'minikube tunnel' in foreground (Ctrl+C to stop). Required for LoadBalancer or 127.0.0.1 access."
    cmds:
      - minikube tunnel -p {{.PROFILE}}
