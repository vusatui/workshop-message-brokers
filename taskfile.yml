# https://taskfile.dev

version: '3'

vars:
  PROFILE: workshop-mb
  REQ_MINIKUBE_VERSION: "1.35.0"
  KPS_VERSION: "79.1.0"
  WELCOME: >
    Welcome! Thank you for showing your interest to this workshop.
    In order to run the playground, you need to have minikube and helm installed.
  FAREWELL: >
    Thank you for your time with us! We hope you found some useful tricks and tips for your tasks

tasks:
  default:
    cmds:
      - task: cluster.start
      - task: dns.add
      - task: deploy.core

  cluster.start:
    desc: Spin up a local cluster
    vars:
      CUR_MINIKUBE_VERSION: "$(minikube version --short | sed -e ''s/[v.]//g'')"
      MIN_MINIKUBE_VERSION: "$(echo {{.REQ_MINIKUBE_VERSION}} | sed -e ''s/[v.]//g'')"
    preconditions:
      - test -x "$(command -v docker)" 
      - test -x "$(command -v helm)"
      - test -x "$(command -v minikube)"
      - sh: '[ "{{.CUR_MINIKUBE_VERSION}}" -ge "{{.MIN_MINIKUBE_VERSION}}" ]'
        msg: |
          Minikube version is too old.
          Please upgrade to version {{.REQ_MINIKUBE_VERSION}} or higher.

    cmds:
      - echo '{{.WELCOME}}' 
      - minikube start --profile={{.PROFILE}} --cpus={{.CPU_COUNT | default "2"}} --memory='{{.MEMORY_SIZE | default "4g"}}'
      - |
        minikube addons -p {{.PROFILE}} enable headlamp 
        minikube addons -p {{.PROFILE}} enable metrics-server 
        minikube addons -p {{.PROFILE}} enable registry 
        minikube addons -p {{.PROFILE}} enable ingress
        minikube addons -p {{.PROFILE}} enable ingress-dns 
        minikube addons -p {{.PROFILE}} enable default-storageclass
        minikube addons -p {{.PROFILE}} enable kubetail
      - kubectl create token headlamp --duration 24h -n headlamp

  cluster.tunnel:
    desc: Run minikube tunnel (requires sudo; blocks until interrupted)
    cmds:
      - sudo minikube tunnel -p {{.PROFILE}}

  cluster.stop:
    desc: Stop the local cluster
    preconditions:
      - test -x "$(command -v docker)" 
      - test -x "$(command -v helm)"
      - test -x "$(command -v minikube)"
    
    cmds:
      - minikube stop --profile={{.PROFILE}}
      - minikube delete --profile={{.PROFILE}}
      - echo '{{.FAREWELL}}'

  dns.add:
    desc: "Configure local DNS to resolve cluster hostnames. Sudo access is required."
    cmds:
      - |
        DNS_IP=$(minikube ip -p {{.PROFILE}})
        if [ -z "$DNS_IP" ]; then
          echo "Could not get minikube IP for profile '{{.PROFILE}}'. Is the cluster running?"
          exit 1
        fi
        echo "Minikube IP found: $DNS_IP"
        
        sudo sed -i.back '/^# >>> minikube-workshop-mb$/,/^# <<< minikube-workshop-mb$/d' /etc/hosts;
        sudo tee -a /etc/hosts >/dev/null << EOF
        # >>> minikube-workshop-mb
        $DNS_IP  headlamp.test
        $DNS_IP  grafana.test
        $DNS_IP  alertmanager.test
        $DNS_IP  prometheus.test
        $DNS_IP  kubetail.test
        # <<< minikube-workshop-mb
        EOF

        echo "Configuration complete. You should now be able to resolve services like http://headlamp.test"

  dns.remove:
    desc: "Remove /etc/hosts entries for workshop ingress block"
    cmds:
      - |
        sudo sed -i.back -e '/^# >>> minikube-workshop-mb$/,/^# <<< minikube-workshop-mb$/d' /etc/hosts
        echo "/etc/hosts entries removed." 

  deploy.core:
    desc: "Deploy the core services, ingress rules and other k8s entities"
    cmds:
      - kubectl apply -f k8s/headlamp-ingress.yml -f k8s/kubetail-ingress.yml
      - | # Install kube-prometheus-stack 
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
        helm upgrade --install monitoring prometheus-community/kube-prometheus-stack --namespace monitoring --create-namespace --values k8s/monitoring/values.yaml --version {{.KPS_VERSION}}

  rollback.core:
    desc: "Uninstall kube-prometheus-stack via Helm"
    cmds:
      - helm uninstall monitoring -n monitoring
      - kubectl delete crd alertmanagerconfigs.monitoring.coreos.com --ignore-not-found=true
      - kubectl delete crd alertmanagers.monitoring.coreos.com --ignore-not-found=true
      - kubectl delete crd podmonitors.monitoring.coreos.com --ignore-not-found=true
      - kubectl delete crd probes.monitoring.coreos.com --ignore-not-found=true
      - kubectl delete crd prometheusagents.monitoring.coreos.com --ignore-not-found=true
      - kubectl delete crd prometheuses.monitoring.coreos.com --ignore-not-found=true
      - kubectl delete crd prometheusrules.monitoring.coreos.com --ignore-not-found=true
      - kubectl delete crd scrapeconfigs.monitoring.coreos.com --ignore-not-found=true
      - kubectl delete crd servicemonitors.monitoring.coreos.com --ignore-not-found=true
      - kubectl delete crd thanosrulers.monitoring.coreos.com --ignore-not-found=true
      - kubectl delete ns monitoring --ignore-not-found=true 

  status.monitoring:
    desc: "Show status of monitoring namespace"
    cmds:
      - kubectl get pods -n monitoring -o wide
      - kubectl get ingress -n monitoring

  get.headlamp-token:
    desc: Issue an access token for headlamp admin panel 
    cmds:
      - kubectl create token headlamp --duration 24h -n headlamp
